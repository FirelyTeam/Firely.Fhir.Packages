# Repo: FirelyTeam/Firely.Fhir.Packages
# File: build/azure-pipelines.yml
name: build-$(Date:yyyyMMdd)$(Rev:-r)

resources:
  repositories:
    - repository: templates
      type: github
      name: FirelyTeam/azure-pipeline-templates
      endpoint: FirelyTeam 

variables:
  buildConfiguration: 'Release'
  vmImage: 'windows-latest'
  GITHUB_PACKAGES_APIKEY: $(GitHubPushPackagesAPIKey)  # key is set in UI of Azure Devops

pool: 
  vmImage: $(vmImage)

trigger:
  branches: 
    include:
    - develop*
    - release*

pr:
  branches:
    include: 
    - develop*
    - hotfix/*

stages:
- stage: build
  jobs:
  - template: build.yml@templates  # Template reference
    parameters:
      dotNetCoreVersion: 6.0.x
      packageArtifacts: true
      restoreDependencies: true
      nuGetServiceConnections: GitHubPackageGetFeed
      nuGetSources: --source https://nuget.pkg.github.com/FirelyTeam/index.json
      pool: 
        vmImage: $(vmImage)

- stage: deploy
  dependsOn: build
  displayName: Deploy packages to GitHub
  jobs:
  - deployment: gitHub
    displayName: GitHub Packages
    environment: GitHub
    strategy:
      runOnce:
        deploy:
          steps:
          - template: push-nuget-package.yml@templates
            parameters:
              artifact: 'NuGet Packages'
              source: https://nuget.pkg.github.com/FirelyTeam/index.json
              apiKey: $(GITHUB_PACKAGES_APIKEY)